<?php
/**
 * @file
 * Code for the Core feature.
 */

include_once 'kcore.features.inc';

/**
 * Implements hook_init().
 */
function kcore_init() {
  drupal_add_js(drupal_get_path('module','kcore') . '/js/kcore.js');
  drupal_add_js(array('creaeleadCoeArea' => array('userLoggedIn' => user_is_logged_in())), 'setting');
  drupal_add_js(drupal_get_path('theme', 'crealead') . '/js/crealead_intra_manage_titles.js', array(
    'type' => 'file',
    'group' => JS_THEME,
  ));
}

/**
 * Implements hook_preprocess_html().
 */
function kcore_preprocess_html(&$variables) {
  global $theme;

  if($theme == 'adminimal') {
    // reference my own stylesheet
      drupal_add_css(drupal_get_path('module', 'kcore') . '/css/admin.css', array('weight' => CSS_THEME));
  }
}

/**
 * Implements hook_menu().
 */
function kcore_menu() {
  $items = array();

  $items['admin/config/crealead'] = array(
    'title' => 'Crealead',
    'description' => 'Paramétrage des fonctionnalités Crealead.',
    'position' => 'left',
    'weight' => -10,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('administer crealead settings'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/crealead/key_figures'] = array(
    'title' => 'Chiffres clés',
    'description' => 'Réglage des chiffres clés Crealead.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('crealead_settings_form'),
    'access arguments' => array('administer crealead settings'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'kcore.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function kcore_permission() {
  return array(
    'administer crealead settings' => array(
      'title' => t('Administer Crealead settings'),
      'description' => t('Administer various settings for Crealead site.'),
    ),
  );
}

/**
 * Implements hook_menu_alter().
 * Thanks to pfournier, creator of module Empty Front Page (https://www.drupal.org/project/empty_front_page)
 */
function kcore_menu_alter(&$items) {
	$items['node']['page callback'] = 'empty_front_page_callback';
}

function empty_front_page_callback() {
	drupal_set_title('');
	return array();
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function kcore_form_user_profile_form_alter(&$form, &$form_state, $form_id) {
  // Shows Referent select field to following roles only : administrateur, webmaster, referent.
  global $user;
  $allowed_roles = array('administrateur','webmaster','référent');
  $user_allowed_roles = array_intersect($allowed_roles, $user->roles);

  if ($user->uid != 1 && empty($user_allowed_roles)) {
	$form['field_user_referent']['#access'] = FALSE;
  }
}

/**
 * Implements hook_email_registration_name().
 */
function kcore_email_registration_name($edit, $account) {
  return $edit['field_user_firstname']['und'][0]['value'] . ' ' . $edit['field_user_lastname']['und'][0]['value'];
}

/**
 * Implements hook_block_info().
 */
function kcore_block_info() {
  $blocks = array();
  $blocks['crealead_coes_number'] = array(
    'info' => t('Crealead : Nombre d\'entrepreneurs'),
  );
  $blocks['crealead_refs_number'] = array(
    'info' => t('Crealead : Nombre de référents'),
  );
  $blocks['crealead_speakers_number'] = array(
    'info' => t('Crealead : Nombre d\'intervenants'),
  );
  $blocks['crealead_meetings_number'] = array(
    'info' => t('Crealead : Nombre de rencontres'),
  );
  $blocks['crealead_sponsors'] = array(
    'info' => t('Crealead : Sponsors'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function kcore_block_view($delta = '') {
  $block = array();

  switch($delta) {
    case 'crealead_coes_number' :
      $coes_number_display = variable_get('coes_number', 1);

      if ($coes_number_display == 1) {
        $number = crealead_users_number('entrepreneur');
      }
      else {
        $number = variable_get('coes_number_value', '100');
      }

      $content = '<div id="coes-number" class="number coes-number">' . $number . '</div>';
      $content .= '<div id="coes-text" class="text coes-text">Co-entrepreneurs <br><span class="under-key-data">et autant de compétences complémentaires</span></div>';
      $block['content'] = $content;
      break;

    case 'crealead_refs_number' :
      $refs_number_display = variable_get('refs_number', 1);

      if ($refs_number_display == 1) {
        $number = crealead_users_number('referent');
      }
      else {
        $number = variable_get('refs_number_value', '100');
      }

      $content = '<div id="refs-number" class="number refs-number">' . $number . '</div>';
      $content .= '<div id="refs-text" class="text refs-text">Membres<br><span class="under-key-data">d’une équipe support pour
accompagner et gérer</span></div>';
      $block['content'] = $content;
      break;

    case 'crealead_speakers_number' :
      $number = variable_get('speakers_number_value', '10');

      $content = '<div id="speakers-number" class="number speakers-number">' . $number . '</div>';
      $content .= '<div id="speakers-text" class="text speakers-text">Intervenants<br><span class="under-key-data">en formations, animations et
prestations.</span></div>';
      $block['content'] = $content;
      break;

    case 'crealead_meetings_number' :
      $number = variable_get('meetings_number_value', '10');

      $content = '<div id="meetings-number" class="number meetings-number">' . $number . '</div>';
      $content .= '<div id="meetings-text" class="text meetings-text">Rencontres par an <br><span  class="under-key-data">organisées pour échanger et
travailler ensemble.</span></div>';
      $block['content'] = $content;
      break;

    case 'crealead_sponsors' :
      $block['subject'] = '';

      $sponsors = array(
        'caisse-epargne' => array(
          'url' => 'https://www.caisse-epargne.fr/languedoc-roussillon/banque-assurance-banque-a-distance.aspx',
          'logo-file' => 'ca-lr_263x57.png'
        ),
        'fond-social-europeen' => array(
          'url' => '',
          'logo-file' => 'fds-social-europeen_506x130.png'
        ),
        'prefecture' => array(
          'url' => '',
          'logo-file' => 'prefecture_78x100.jpg'
        ),
        'montpellier-metropole' => array(
          'url' => 'http://www.montpellier3m.fr/',
          'logo-file' => 'montpellier-metropole_100x100.png'
        ),
        'cd34' => array(
          'url' => 'http://www.herault.fr/',
          'logo-file' => 'CD34_134x63.png'
        ),
      );

      $path = drupal_get_path('module', 'kcore') . '/sponsors-logos/';
      $content = '<div id="crealead-sponsor">';
      foreach ($sponsors as $name=>$sponsor) {
        $content .= '<span id="' . $name . '">';
        $img = theme('image', array('path' => $path . $sponsor['logo-file']));
        if ($sponsor['url'] != '') {
          $logo = l($img,$sponsor['url'], array('html' => TRUE));
        }
        else {
          $logo = $img;
        }
        $content .= $logo;
        $content .= '</span>';
      }
      $content .= '</div>';
      $block['content'] = $content;
      break;
  }

  return $block;
}

/**
 * Helper functions.
 */

/**
 * Returns the number of active user belonging to role given as paramater.
 * Il no role is passed on, returns the total number of active users.
 *
 * @param $role
 *   A role machine name (ex. Référent role's machine name is 'referent').
 *
 * @return
 *   The number of users.
 */
function crealead_users_number($role=null) {
  $query = db_select('users_roles', 'ur')->fields('ur', array('uid'));
  if (isset($role)) {
    $role = user_role_load_by_name($role);
    $query->condition('ur.rid', $role->rid);
  }
  else {
    $query->distinct();
  }
  $result = $query->execute()->fetchCol();

  return count($result);
}

function kcore_admin_menu_output_alter(&$content) {
  if (isset($content['menu']['admin/index'])) {
    unset($content['menu']['admin/index']);
  }
}

/**
 * Implements hook_node_access().
 */
function kcore_node_access($node, $op, $account) {
  if (isset($node->type) && $node->type == 'webform' && !user_is_logged_in()) {
    return NODE_ACCESS_DENY;
  }
}

/**
 * Implements hook_block_view_alter().
 */
function kcore_block_view_alter(&$data, $block) {
  if ($block->delta == 'menu-coe-area' && !user_is_logged_in()) {
    $data['content'] = array();
  }
}
