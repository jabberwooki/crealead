<?php
/**
 * @file
 * Code for the Marques feature.
 */

include_once 'crealead_brands.features.inc';

/**
 * Implements hook_init().
 */
function crealead_brands_init() {
  $node = menu_get_object();
  if (!empty($node) && $node->type == 'brand') {
    drupal_add_js(drupal_get_path('module','crealead_brands') . '/js/crealead_brands.js');
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function crealead_brands_form_brand_node_form_alter(&$form, &$form_state, $form_id) {
  // unallowed users cannot create 'grande marque' brands.
  global $user;
  $current_user_roles = $user->roles;
  $crealead_news_allowed_roles = array('administrateur','webmaster','référent');
  $current_user_allowed_roles = array_intersect($crealead_news_allowed_roles, $current_user_roles);
  if (empty($current_user_allowed_roles) & $user->uid != 1) {
    unset($form['field_brand_type']['und']['#options'][3]);
  }

  // Move "Champs Crealed" vertical tab to the bottom.
  $form['#groups']['group_crealead_fields']->weight = 200;

  $form['#after_build'][] = 'crealead_brands_after_build';
}

function crealead_brands_after_build($form, &$form_state) {
  // Make the field field_brand_search readonly.
  $form['field_brand_search']['und'][0]['value']['#attributes']['readonly'] = 'readonly';
  $form_state['values']['field_brand_search']['und'][0]['value'] = $form['field_brand_search']['und'][0]['value']['#default_value'];

  return $form;
}

/**
 * Implements hook_node_presave().
 */
function crealead_brands_node_presave($node) {
  if ($node->type == 'brand') {
    $coe_names = '';
    $coe_competencies = '';
    // Fetch all coes names and competencies linked to current brand.
    foreach($node->field_brand_coes['und'] as $fc_item) {
      dpm($fc_item);
      $coe_id = $fc_item['field_brand_coe']['und'][0]['target_id'];
      $coe = user_load($coe_id);
      $coe_names .= $coe->name . ' ';

      foreach ($fc_item['field_competencies']['und'] as $competency) {
        $coe_competencies .= $competency['name'] . ' ';
      }
    }

    // Store names, competencies and solutions into field_brand_search technical field.
    $search_data = $coe_names
      . $coe_competencies
      . $node->field_brand_solutions['und'][0]['value'];
    $search_array = array('value' => $search_data, 'format' => 'plain_text');

    if (!isset($node->field_brand_search['und'][0])) {
      $node->field_brand_search['und'][] = $search_array;
    }
    else {
      $node->field_brand_search['und'][0] = $search_array;
    }
  }
}

/**
 * Implements hook_node_view_alter().
 */
function crealead_brands_node_view_alter(&$build) {
//  dpm($build);
//  if ($build['#bundle'] == '') {
//
//  }
}

/**
 * Implements hook_node_grants_alter().
 */
function crealead_brands_node_grants_alter(&$grants, $account, $op) {
  var_dump($grants);
}

/**
 * Implements hook_block_info().
 */
function crealead_brands_block_info() {
  $blocks = array();
  $blocks['crealead_brands_number'] = array(
    'info' => t('Crealead : Nombre de grandes marques'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function crealead_brands_block_view($delta = '') {
  $block = array();

  switch($delta) {
    case 'crealead_brands_number' :
      $content = '<div class="number  brands-number">' . crealead_main_brands_number() . '</div>';
      $content .= '<div class="text brands-text">' . 'grandes marques' . '</div>';
      $block['content'] = $content;
      break;
  }

  return $block;
}

/**
 * Helper functions.
 */

/**
 * Returns the number of main brands (grandes marques).
 *
 * @return
 *   The number of main brands.
 */
function crealead_main_brands_number() {
  $query = db_select('node','n')->fields('n', array('nid'));
  $query->join('field_data_field_brand_type','bt', 'n.nid=bt.entity_id');
  $query->condition('n.status', '1');
  $query->condition('bt.field_brand_type_value', '3');
  $result = $query->execute()->fetchCol();

  return count($result);
}