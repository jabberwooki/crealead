<?php
/**
 * @file
 * Code for the Marques feature.
 */

include_once 'crealead_brands.features.inc';

/**
 * Implements hook_init().
 */
function crealead_brands_init() {
  $node = menu_get_object();
  if (!empty($node) && $node->type == 'brand' && arg(2) != 'edit') {
    drupal_add_js(drupal_get_path('module','crealead_brands') . '/js/crealead_brands.js');
    drupal_add_css(drupal_get_path('module','crealead_brands') . '/css/crealead_brands.css');
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function crealead_brands_form_brand_node_form_alter(&$form, &$form_state, $form_id) {
  // unallowed users cannot create 'grande marque' brands.
  global $user;
  $current_user_roles = $user->roles;
  $crealead_news_allowed_roles = array('administrateur','webmaster','référent');
  $current_user_allowed_roles = array_intersect($crealead_news_allowed_roles, $current_user_roles);
  if (empty($current_user_allowed_roles) & $user->uid != 1) {
    unset($form['field_brand_type']['und']['#options'][3]);
  }

  // Move "Champs Crealed" vertical tab to the bottom.
  $form['#groups']['group_crealead_fields']->weight = 200;

  $form['#after_build'][] = 'crealead_brands_after_build';
}

function crealead_brands_after_build($form, &$form_state) {
  // Make the field field_brand_search readonly.
  $form['field_brand_search']['und'][0]['value']['#attributes']['readonly'] = 'readonly';
  $form_state['values']['field_brand_search']['und'][0]['value'] = $form['field_brand_search']['und'][0]['value']['#default_value'];

  return $form;
}

/**
 * Implements hook_node_presave().
 */
function crealead_brands_node_presave($node) {
  if ($node->type == 'brand') {
    $coe_names = '';
    $coe_competencies = '';
    // Fetch all coes names and competencies linked to current brand.
    foreach($node->field_brand_coes['und'] as $fc_item) {
      $coe_id = $fc_item['field_brand_coe']['und'][0]['target_id'];
      $coe = user_load($coe_id);
      $coe_names .= $coe->name . ' ';

      foreach ($fc_item['field_competencies']['und'] as $competency) {
        $coe_competencies .= $competency['name'] . ' ';
      }
    }

    // Store names, competencies and solutions into field_brand_search technical field.
    $search_data = $coe_names
      . $coe_competencies
      . $node->field_brand_solutions['und'][0]['value'];
    $search_array = array('value' => $search_data, 'format' => 'plain_text');

    if (!isset($node->field_brand_search['und'][0])) {
      $node->field_brand_search['und'][] = $search_array;
    }
    else {
      $node->field_brand_search['und'][0] = $search_array;
    }
  }
}

/**
 * Implements hook_views_data_alter().
 */
/**
 * Implements hook_views_pre_view().
 */
function crealead_brands_views_pre_view(&$view, &$display_id, &$args) {
//  if ($display_id == 'eva_contacts_list') {
//    dpm($view);
//  }
}

/**
 * Implements hook_views_pre_render().
 */
function crealead_brands_views_pre_render(&$view) {
//  if ($view->current_display == 'eva_contacts_list') {
//    dpm($view);
//    $view->result = array();
//  }
}

/**
 * Implements hook_node_grants_alter().
 */
function crealead_brands_node_grants_alter(&$grants, $account, $op) {
  var_dump($grants);
}

/**
 * Implements hook_block_info().
 */
function crealead_brands_block_info() {
  $blocks = array();
  $blocks['crealead_brands_number'] = array(
    'info' => t('Crealead : Nombre de grandes marques'),
  );
  $blocks['crealead_brands_contacts_list'] = array(
    'info' => t('Crealead : Liste des contacts email'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function crealead_brands_block_view($delta = '') {
  $block = array();

  switch($delta) {
    case 'crealead_brands_number' :
      $content = '<div class="number  brands-number">' . crealead_main_brands_number() . '</div>';
      $content .= '<div class="text brands-text">' . 'grandes marques' . '</div>';
      $block['content'] = $content;
      break;
    case 'crealead_brands_contacts_list' :
      $block['content'] = crealead_brand_contacts_list();
      break;
  }

  return $block;
}

/**
 * Implements hook_entity_view().
 */
function crealead_brands_entity_view($entity, $type, $view_mode, $langcode) {
  //dpm($entity);
}

/**
 * Implements hook_entity_view_alter().
 */
function crealead_brands_entity_view_alter(&$build, $type) {
  if ($build['#entity_type'] == 'entityform_type' && $build['#entity']->type == 'contact' && $build['#view_mode'] == 'full') {
    $build['#entity']->label = '';
    $build['#entity']->data['redirect_path'] = substr($_SERVER['REDIRECT_URL'],1);
  }

  if ($build['#entity_type'] == 'node' && $build['#bundle'] == 'brand' && $build['#view_mode'] == 'full') {
    if (!isset($build['field_brand_email'])) {
      unset($build['field_contact_form']);
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function crealead_brands_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'contact_entityform_edit_form') {
    $node = menu_get_object();
    if (isset($node->field_contact_form)) {
      // Brand name added to form
      $form['field_contact_brand_name'][LANGUAGE_NONE][0]['value']['#default_value'] = $node->title;
      // Brand nid added to form
      $form['field_brand_nid'][LANGUAGE_NONE][0]['value']['#default_value'] = $node->nid;
      // Brand email added to form
      if (isset($node->field_brand_email['und'][0]['email'])) {
        $form['field_contact_brand_email'][LANGUAGE_NONE][0]['value']['#default_value'] =
          $node->field_brand_email['und'][0]['email'];
      }
    }
  }
}

/**
 * Helper functions.
 */

/**
 * Returns the number of main brands (grandes marques).
 *
 * @return
 *   The number of main brands.
 */
function crealead_main_brands_number() {
  $query = db_select('node','n')->fields('n', array('nid'));
  $query->join('field_data_field_brand_type','bt', 'n.nid=bt.entity_id');
  $query->condition('n.status', '1');
  $query->condition('bt.field_brand_type_value', '3');
  $result = $query->execute()->fetchCol();

  return count($result);
}

/**
 * Returns the view's markup for the current brand's contacts list if current user is allowed to view it.
 * Otherwise returns an empty string.
 *
 * Users allowed to view current brand's email contacts list are :
 * - superadmin (uid=1)
 * - users with role administrator, webmaster and referent
 * - all coes attached to current brand
 *
 * @return string
 *   The listing brand's contacts markup or an empty string.
 */
function crealead_brand_contacts_list() {
  $node = menu_get_object();
  $allowed_uids = array('1');

  if (!empty($node->field_brand_coes)) {
    $fc_coes = $node->field_brand_coes['und'];
    foreach ($fc_coes as $fc_item_id) {
      $wrapper = entity_metadata_wrapper('field_collection_item', $fc_item_id['value']);
      $fc_item = $wrapper->value();
      $allowed_uids[] = $fc_item->field_brand_coe['und'][0]['target_id'];
    }
  }

  $allowed_roles = array('administrateur','webmaster','référent');
  global $user;

  $output = '';
  if (in_array($user->uid, $allowed_uids) || sizeof(array_intersect($allowed_roles, $user->roles)) > 0) {
    $output = views_embed_view('brand_contact_submissions', 'brand_contacts');
  }
  return $output;
}