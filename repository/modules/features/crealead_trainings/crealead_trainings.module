<?php
/**
 * @file
 * Code for the Formations feature.
 */

include_once 'crealead_trainings.features.inc';

define('ADD_TO_SESSION_TEXT', 'Je suis intéressé(e)');
define('REMOVE_FROM_SESSION_TEXT', 'Je ne suis plus intéressé(e)');

/**
 * Implements hook_permission().
 */
function crealead_trainings_permission() {
  return array(
    'administer trainings' => array(
      'title' => t('Administrer les formations'),
    )
  );
}

/**
 * Implements hook_menu().
 */
function crealead_trainings_menu() {
  $items['remove_user_from_session/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'crealead_trainings_session_remove_user',
    'access arguments' => array('access content'),
    'access callback' => TRUE,
    'file' => 'crealead_trainings_sessions.ajax.inc',
  );

  $items['admin/config/crealead/trainings'] = array(
    'title' => 'Formations',
    'description' => 'Paramétrage des formations.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('crealead_trainings_settings_form'),
    'access arguments' => array('administer trainings'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'crealead_trainings.admin.inc',
  );

  $items['add_recommendation/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'crealead_trainings_add_recommendation',
    'access arguments' => array('acces content'),
    'access callback' => TRUE,
    'file' => 'crealead_trainings.ajax.inc',
  );

  $items['remove_recommendation/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'crealead_trainings_remove_recommendation',
    'access arguments' => array('acces content'),
    'access callback' => TRUE,
    'file' => 'crealead_trainings.ajax.inc',
  );

  $items['add_recommendation_from_list/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'crealead_trainings_add_recommendation_from_list',
    'access arguments' => array('acces content'),
    'access callback' => TRUE,
    'file' => 'crealead_trainings.ajax.inc',
  );

  $items['add_recommendation_from_brand_tab/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'crealead_trainings_add_recommendation_from_brand_tab',
    'access arguments' => array('acces content'),
    'access callback' => TRUE,
    'file' => 'crealead_trainings.ajax.inc',
  );

  $items['remove_recommendation_from_brand_tab/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'crealead_trainings_remove_recommendation_from_brand_tab',
    'access arguments' => array('acces content'),
    'access callback' => TRUE,
    'file' => 'crealead_trainings.ajax.inc',
  );

  return $items;
}

function crealead_trainings_form_training_node_form_alter(&$form, &$form_state, $form_id) {
  drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_trainings.js');

  global $user;
  $current_user_roles = $user->roles;
  $crealead_trainings_allowed_roles = array('administrateur','webmaster','référent');
  $current_user_allowed_roles = array_intersect($crealead_trainings_allowed_roles, $current_user_roles);

  // Related brands list handling ----------------------------------------------
  // The training create/edit form always contains a user id.
  // If training is being created, user id is the current user id.
  // If training is being modified, user id is the training author id.
  // In either cases, we must seek for brands the concerned user belongs to.
  $query = db_select('field_data_field_brand_coe', 'coe');
  $query->fields('coe', array('entity_id', 'field_brand_coe_target_id'));
  $query->join('field_data_field_brand_coes', 'coes', 'coes.field_brand_coes_value=coe.entity_id');
  $query->fields('coes', array('entity_id'));
  $query->condition('field_brand_coe_target_id', $form['uid']['#value']);
  $training_brands = $query->execute()->fetchAllKeyed(2, 2);

  $brand_options = $form['field_training_related_brands']['und']['#options'];
  foreach ($brand_options as $key => $brand) {
    if (!in_array($key, $training_brands)) {
      unset($brand_options[$key]);
    }
  }
  $form['field_training_related_brands']['und']['#options'] = $brand_options;

  // Then, if training is being modified and current user is not news author,
  // we must display a disabled brand list, unless current used is allowed to.
  if (isset($form['nid']['#value']) && $user->uid != $form['uid']['#value'] && empty($current_user_allowed_roles) & $user->uid != 1) {
    $form['field_training_related_brands']['#disabled'] = TRUE;
  }
  // End of Related brands list handling ---------------------------------------

  // If training is being created from a brand page,
  // we must catch the brand nid from url
  // and check the corresponding brand in field_related_brands field.
  if (!isset($form['nid']['#value']) && NULL != arg(3)) {
    $form['field_training_related_brands']['und']['#default_value'] = arg(3);
  }
  // End of Related brands list handling ---------------------------------------

  // We must display only sector brands and certifications/labels the parent brand(s) of the current training is (are) related to.
  // First, we get the parent brands.
  $parent_brands = crealead_trainings_get_parent_brands($form['nid']['#value']);
  $parent_certifs_labels = crealead_brands_get_parent_certifs_labels($parent_brands);

  // If any parent brands exist, we get the sector brands of each parent brand.
  if (!empty($parent_brands)) {
    $parent_sector_brands = crealead_brands_get_parent_sector_brands($parent_brands);

    // If any parent sector brands exist
    if (!empty($parent_sector_brands)) {
      // We have to clean the sector brand field options array by keeping only the parent sector brands.
      $form['field_related_sector_brands']['und']['#options'] =
        crealead_clean_sector_brands_options($form['field_related_sector_brands']['und']['#options'], $parent_sector_brands);
    }
    // otherwise we remove the related sector brands field from display.
    else {
      $form['field_related_sector_brands']['#access'] = FALSE;
    }

    // If any certif/label exists
    if (!empty($parent_certifs_labels)) {
      // We have to clean the certifications/labels field options array by keeping only the parent ones.
      $form['field_related_certifs_labels']['und']['#options'] =
        crealead_clean_certifs_labels_options($form['field_related_certifs_labels']['und']['#options'], $parent_certifs_labels);
    }
    else {
      $form['field_related_certifs_labels']['#access'] = FALSE;
    }
  }
  // otherwise we remove the related sector brands field from display.
  else {
    $form['field_related_sector_brands']['#access'] = FALSE;
    $form['field_related_certifs_labels']['#access'] = FALSE;
  }

  // Hide recommended by field to all users, but admin and superadmin.
  if (!in_array('administrateur', $current_user_roles) && $user->uid != 1) {
    unset($form['field_recommended_by']);
  }


  // Move "Champs Crealed" vertical tab to the bottom.
  $form['#groups']['group_crealead_fields']->weight = 200;

  // Stuff that has to be done after form build.
  $form['#after_build'][] = 'crealead_trainings_after_build';

  // Hide scheduled sessions field (handled now by sessions view).
  //$form['field_scheduled_sessions']['#access'] = FALSE;

  // Previous publication status is stored in the readonly field_previous_status.
  $form['field_previous_status']['und'][0]['value']['#default_value'] = $form['#entity']->status;

  $form['#submit'][] = 'crealead_trainings_training_submit_handler';
}

function crealead_trainings_training_submit_handler($form, &$form_state) {
  if ($form_state['values']['field_previous_status']['und'][0]['value'] == 0
    && $form_state['values']['status']
    && sizeof(crealead_trainings_get_training_sessions($form_state['values']['nid']))) {
    drupal_set_message('ATTENTION ! toutes les sessions rattachées à cette formation viennent d\'être republiées.', 'warning');
  }
}

function crealead_trainings_after_build($form, &$form_state) {
  // Make the field field_training_search readonly.
  $form['field_training_search']['und'][0]['value']['#attributes']['readonly'] = 'readonly';
  $form_state['values']['field_training_search']['und'][0]['value'] = $form['field_training_search']['und'][0]['value']['#default_value'];

  // Make the field field_previous_status readonly.
  $form['field_previous_status']['und'][0]['value']['#attributes']['readonly'] = 'readonly';

  return $form;
}

/**
 * Implements hook_entity_view_alter().
 */
function crealead_trainings_entity_view_alter(&$build, $type) {
//  if ($type == 'node' && $build['#bundle'] == 'training' && $build['#view_mode'] == 'full') {
  if ($type == 'node' && $build['#bundle'] == 'training') {
    drupal_add_css(drupal_get_path('module', 'crealead_trainings') . '/css/crealead_trainings.css');

    if ($build['#view_mode'] == 'full') {
      ////////////////// CONTACTEZ-NOUS //////////////////////////////////////////
      if (!empty($build['field_training_related_brands']['#items'][0]['entity']->field_brand_email['und'][0]['email'])) {
        $email = $build['field_training_related_brands']['#items'][0]['entity']->field_brand_email['und'][0]['email'];
        $link = '/' . drupal_get_path_alias('node/' . $build['field_training_related_brands']['#items'][0]['entity']->nid)
          . '#bootstrap-fieldgroup-nav-item--contact';
        $contact_link = '<a href="' . $link . '">' . $email . '</a>';
        $build['training_contact'][0]['#markup'] = $contact_link;
      }
      else {
        unset($build['training_contact']);
      }

      //////////////////// CREALEAD FUNDED ///////////////////////////////////////
      if (!empty($build['#node']->field_crealead_funded) && $build['#node']->field_crealead_funded['und'][0]['value'] == 1) {
        $tarif_markup = $build['field_training_price'][0]['#markup'];
        $logo_markup = crealead_trainings_get_funded_logo_markup();

        $build['field_training_price'][0]['#markup'] =
          '<div class="training-funded-logo">' .
          $logo_markup .
          '</div>' .
          $tarif_markup;
      }

      ///////////////// SESSIONS HANDLING ////////////////////////////////////////
      // From now on, sessions field value is the concatenation of data entered by user in add/edit form
      // + content provided by the trainings/next_sessions view display.
      $previous_sessions_markup = $build['field_scheduled_sessions'][0]['#markup'];
      $sessions_list = '';
      $sessions_user_links = '';

      $trainings_view = views_get_view('trainings');
      $trainings_view->set_display('sessions_count');
      $trainings_view->pre_execute();
      $sessions_number = trim(strip_tags($trainings_view->render('sessions_count')));

      if ($sessions_number > 0) {
        // Initial version of sessions list (discarded, then re-used).
        $trainings_view = views_get_view('trainings');
        $trainings_view->set_display('next_sessions');
        $trainings_view->pre_execute();
        $sessions_list .= $trainings_view->render('next_sessions');

  //      // New version of sessions list, but eventually discarded (see function crealead_trainings_get_next_sessions() below).
  //      $sessions_list = crealead_trainings_get_next_sessions($build['#node']);

        // At the moment we know that at least one training session exists,
        // we can remove the mention "Nous contacter"
        // which is the field_scheduled_sessions saved default value (see crealead_trainings_node_presave hook).
        if (strstr($previous_sessions_markup, 'Nous contacter')) {
          $previous_sessions_markup = '';
        }

        if ($sessions_number > 3 ) {
          $sessions_list_link = l('Voir toutes les sessions', '/formations/toutes-les-sessions/' . $build['#node']->nid);
          $sessions_list .= '<div class="session-list-link">' . $sessions_list_link . '</div>';
        }
      }
      global $user;
      if ($user->uid == $build['#node']->uid) {
        // On récupère l'info Formation financée par la structure
        $funded = '/0';
        if (isset($build['#node']->field_crealead_funded['und'][0]['value'])) {
          $funded = '/' . $build['#node']->field_crealead_funded['und'][0]['value'];
        }
        $new_session_link = l(
          'Créer une session',
          '/node/add/training-session/' . $build['#node']->nid . $funded,
          array('query' => array('destination' => current_path()))
        );
        $sessions_user_links .= '<div class="new-session-link">' . $new_session_link . '</div>';
      }
      $build['field_scheduled_sessions'][0]['#markup'] = $previous_sessions_markup . $sessions_list . $sessions_user_links;
    }
    elseif ($build['#view_mode'] == 'list' || $build['#view_mode'] == 'teaser') {
      if (!empty($build['#node']->field_crealead_funded) && $build['#node']->field_crealead_funded['und'][0]['value'] == 1) {
        $type_markup = $build['field_training_type'][0]['#markup'];
        $logo_markup = crealead_trainings_get_funded_logo_markup();

        $build['field_training_type'][0]['#markup'] =
          '<div class="training-funded-logo">' .
          $logo_markup .
          '</div>' .
          $type_markup;
      }
    }
  }
}

function crealead_trainings_get_funded_logo_markup() {
  $logo_markup = 'Logo manquant';

  if ($logo_fid = variable_get('crealead_training_funded_logo_fid', FALSE)) {
    if ($image = file_load($logo_fid)) {
      $logo_markup = theme(
        'image_style',
        array(
          'style_name' => 'funded_logo',
          'path' => $image->uri,
          'alt' => 'Prise en charge partielle du financement par Crealead pour les Crealeadiens',
          'title' => 'Prise en charge partielle du financement par Crealead pour les Crealeadiens',
        )
      );
    }
  }

  return $logo_markup;
}

/**
 * Implements hook_node_view().
 */
function crealead_trainings_node_view($node, $view_mode, $langcode) {
  if ($node->type == 'training_session') {
    drupal_add_css(drupal_get_path('module','crealead_trainings') . '/css/crealead_training_session_popup.css');
  }
  if ($node->type == 'training') {
    if ($view_mode == 'full') {
      drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_view_trainings.js');
      drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_training_full.js');

      global $user;
      if(!user_is_logged_in() || $node->uid == $user->uid) {
        unset($node->content['recommendation_action']);
      }
      else {
        $ajax_link_url = '/add_recommendation/' . $node->nid . '/nojs';
        $ajax_link_text = 'Je recommande cette formation';

        if (isset($node->field_recommended_by['und'])) {
          foreach ($node->field_recommended_by['und'] as $coe_entity) {
            if ($coe_entity['target_id'] == $user->uid) { // Current user is already in recommenders list.
              $ajax_link_url = '/remove_recommendation/' . $node->nid . '/nojs';
              $ajax_link_text = 'Je ne recommande plus cette formation';
              break;
            }
          }
        }

        $node->content['recommendation_action'][0]['#markup'] =
          '<a href="' . $ajax_link_url . '" class="use-ajax">' . $ajax_link_text . '</a>';
      }
    }
    elseif ($view_mode == 'list') {
      if (isset($node->content['field_recommended_by'])) {
        $number = sizeof(element_children($node->content['field_recommended_by']));
        $plural = ($number > 1) ? 's' : '';
        $node->content['recommendations_number'][0]['#markup'] =
          '<div class="field field-name-field-recommendations-number">' .
          'Recommandé par ' . $number  . ' personne' . $plural .
          '</div>';

        unset($node->content['field_recommended_by']);
      }
      else {
        unset($node->content['recommendations_number']);
      }

      global $user;
      if(!user_is_logged_in() || $node->uid == $user->uid) {
        unset($node->content['recommendation_action']);
      }
      else {
        $ajax_link_url = '/add_recommendation_from_list/' . $node->nid . '/nojs';
        $ajax_link_text = 'Je recommande cette formation';

        if (isset($node->field_recommended_by['und'])) {
          foreach ($node->field_recommended_by['und'] as $coe_entity) {
            if ($coe_entity['target_id'] == $user->uid) { // Current user is already in recommenders list.
              $ajax_link_url = '/remove_recommendation_from_list/' . $node->nid . '/nojs';
              $ajax_link_text = 'Je ne recommande plus cette formation';
              break;
            }
          }
        }

        $node->content['recommendation_action'][0]['#markup'] =
          '<a href="' . $ajax_link_url . '" class="use-ajax">' . $ajax_link_text . '</a>';
      }
    }
    elseif ($view_mode == 'teaser') {
      drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_training_list.js');

      if (isset($node->content['field_recommended_by'])) {
        $number = sizeof(element_children($node->content['field_recommended_by']));
        $plural = ($number > 1) ? 's' : '';
        $node->content['recommendations_number'][0]['#markup'] =
          '<div class="field field-name-field-recommendations-number">' .
          'Recommandé par ' . $number  . ' personne' . $plural .
          '</div>';

        unset($node->content['field_recommended_by']);
      }
      else {
        unset($node->content['recommendations_number']);
      }

      global $user;
      if(!user_is_logged_in() || $node->uid == $user->uid) {
        unset($node->content['recommendation_action']);
      }
      else {
        $ajax_link_url = '/add_recommendation_from_brand_tab/' . $node->nid . '/nojs';
        $ajax_link_text = 'Je recommande cette formation';

        if (isset($node->field_recommended_by['und'])) {
          foreach ($node->field_recommended_by['und'] as $coe_entity) {
            if ($coe_entity['target_id'] == $user->uid) { // Current user is already in recommenders list.
              $ajax_link_url = '/remove_recommendation_from_brand_tab/' . $node->nid . '/nojs';
              $ajax_link_text = 'Je ne recommande plus cette formation';
              break;
            }
          }
        }

        $node->content['recommendation_action'][0]['#markup'] =
          '<a href="' . $ajax_link_url . '" class="use-ajax">' . $ajax_link_text . '</a>';
      }
    }
  }
  elseif ($node->type == 'training_session' && $view_mode == 'colorbox') {
    drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_training_session_popup.js');
    drupal_add_css(drupal_get_path('module','crealead_trainings') . '/css/crealead_training_session_popup.css');

    // If visitor comes from training full node, we remove the link "Voir toutes les sessions".
    $referer = $_SERVER['HTTP_REFERER'];
    if (strpos($referer, '/formations/') !== false) {
      unset($node->content['see_all_sessions_link'][0]['#markup']);
    }
    // else we create the hyperlink pointing to the training full node.
    else {
      $node->content['see_all_sessions_link'][0]['#markup'] =
        '<a href="/node/' . $node->field_related_training['und'][0]['entity']->nid . '">' .
        'Voir les sessions à venir' .
        '</a>';
    }

    // Crealead funded logo display
    if (!empty($node->content['field_funded_session'])) {
      if ($node->content['field_funded_session'][0]['#markup'] == 'non') {
        unset($node->content['field_funded_session']);
      }
      else {
        $node->content['field_funded_session'][0]['#markup'] = crealead_trainings_get_funded_logo_markup();
      }
    }

    // Addition of the 'Jour N - ' prefix.
    $element = $node->content['field_session_dates'];
    $children = array_intersect_key($element, element_children($element));
    $count = 0;
    foreach ($children as $key => $child) {
      $markup = $child['#markup'];
      $tag_content = strip_tags($child['#markup']);
      $node->content['field_session_dates'][$key]['#markup'] = str_replace($tag_content, 'Jour ' . ++$count . ' - ' . $tag_content, $markup);
    }

    /////////// Interested/Not interested switch link handling. ////////////////
    global $user;
    // If current user is the session author, the switch is not displayed.
    if ($user->uid == $node->uid) {
      unset($node->content['interested_switch']);
    }
    else {
      // Table of interested users if visible only to allowed rôles (Trello V3 S6-5).
      $current_user_roles = $user->roles;
      $crealead_trainings_allowed_roles = array('administrateur','webmaster','pôle gestion');
      $current_user_allowed_roles = array_intersect($crealead_trainings_allowed_roles, $current_user_roles);
      if (empty($current_user_allowed_roles) && $user->uid != 1) {
        unset($node->content['field_interested_users']);
      }

      $is_already_interested = false;
      // If session already contains interested users,
      // we must check if the current user is one of these.
      if (!empty($node->field_interested_users)) {
        $session_wrapper = entity_metadata_wrapper('node', $node);
        $interested_users = $session_wrapper->field_interested_users->value();

        foreach ($interested_users as $interested_user) {
          if ($interested_user->field_user_name['und'][0]['target_id'] == $user->uid) {
            $is_already_interested = true;
            break;
          }
        }
      }
      $node->content['interested_switch'][0]['#markup'] = crealead_trainings_get_interest_widget($is_already_interested, $node->nid, $user);
     ///////// End of Interested/Not interested switch link handling. //////////
    }
  }
}

function crealead_trainings_get_interest_widget($is_already_interested=true, $session_nid, $user) {
  if ($is_already_interested) {
    $output =
      '<div id="session-switch-wrapper">' .
        '<a href="/remove_user_from_session/' . $session_nid .'/nojs" class="use-ajax">' .
          REMOVE_FROM_SESSION_TEXT .
        '</a>' .
      '</div>';
  }
  else {
    $vars = array('session_nid' => $session_nid, 'user' => $user);

    $output =
      '<div id="session-switch-wrapper">' .
        '<a class="btn btn-primary add-to-session-open-close">' . ADD_TO_SESSION_TEXT . '</a>' .
        '<div class="user-details" style="display: none">' .
            drupal_render(drupal_get_form('crealead_trainings_add_user_to_session_form', $vars)) .
        '</div>'.
      '</div>';
  }

  return $output;
}

function crealead_trainings_add_user_to_session_form($form, &$form_state, $vars) {
  $form['session_nid'] = array(
    '#type' => 'hidden',
    '#value' => $vars['session_nid'],
  );

  $user = $vars['user'];
  $form['user_name'] = array(
    '#type' => 'item',
    '#title' => 'Votre nom',
    '#markup' => '<div class="user-name-markup">' . $user->name . '</div>',
  );

  $form['user_contact'] = array(
    '#type' => 'textfield',
    '#title' => 'Contact (email, tél...)',
    '#default_value' => $user->mail,
    '#description' => '(Votre email, votre n° de tél...)',
    '#required' => TRUE,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Soumettre',
    '#ajax' => array(
      'callback' => 'crealead_trainings_add_user_to_session',
      'wrapper' => 'session-switch-wrapper',
    ),
  );

  return $form;
}

function crealead_trainings_add_user_to_session($form, $form_state) {
  if (form_get_errors()) {
    return $form;
  }

  global $user;
  $session_nid = $form_state['values']['session_nid'];
  $contact = $form_state['values']['user_contact'];

  // First, we create a new field collection item from passed on data.
  $fci_values = array(
    'field_name' => 'field_interested_users',
    'field_user_name' => array(
      LANGUAGE_NONE => array(array('target_id' => $user->uid)),
    ),
    'field_user_contact' => array(
      LANGUAGE_NONE => array(array('value' => $contact)),
    ),
  );
  if (!$fc_entity = entity_create('field_collection_item', $fci_values)) {
    watchdog('crealead_trainings', 'Field collection item creation failed.');
  }
  else {
    // Then, we attach it to parent node
    $session = node_load($session_nid);
    $fc_entity->setHostEntity('node', $session);
    $fc_entity->save();
  }

  // Then, we change the session's colorbox switch link.
  return crealead_trainings_get_interest_widget(true, $session_nid, $user);

}

/**
 * Implements hook_node_presave().
 */
function crealead_trainings_node_presave($node) {
  if ($node->type == 'training') {
     // If Sessions programmmées field is empty, the default content is "Nous contacter".
    if (empty($node->field_scheduled_sessions['und'])) {
      $node->field_scheduled_sessions['und'][] = array(
        'value' => '<p>Nous contacter</p>',
        'format' => 'full_html',
      );
    }

    // --- Technical field_training_search field handling --- //
    $training_intro = '';
    $training_public = '';
    $training_aims = '';
    $certifs_labels_names = '';
    $title = $node->title . ' ';
    $training_content = strip_tags($node->body['und'][0]['value']) . ' ';

    if (!empty($node->field_introduction['und'])) {
      $training_intro .= strip_tags($node->field_introduction['und'][0]['value']);
    }

    if (!empty($node->field_training_public['und'])) {
      $training_public .= strip_tags($node->field_training_public['und'][0]['value']);
    }
    if (!empty($node->field_training_aims['und'])) {
      $training_aims = strip_tags($node->field_training_aims['und'][0]['value']);
    }

    foreach ($node->field_training_related_brands['und'] as $brand) {
      $wrapper = entity_metadata_wrapper('node', $brand['target_id']);
      $certifs_labels = $wrapper->field_certifications_labels->value();
      foreach ($certifs_labels as $certif_label) {
        $term = taxonomy_term_load($certif_label->tid);
        $certifs_labels_names .= $term->name . ' ';
      }
    }
    // Store training intro, content, public and objectives into field_training_search technical field.
    $search_data =  $title . $training_intro . $training_content . $training_public . $training_aims . $certifs_labels_names;

    $search_array = array('value' => $search_data, 'format' => 'plain_text');
    if (!isset($node->field_training_search['und'][0])) {
      $node->field_training_search['und'][] = $search_array;
    }
    else {
      $node->field_training_search['und'][0] = $search_array;
    }
    // --- End of technical field_training_search field handling --- //
  }
}

function crealead_trainings_get_parent_brands($training_id) {
  if (!isset($training_id)) return array();

  $query = db_select('field_data_field_training_related_brands', 'ftrb');
  $query->fields('ftrb', array('field_training_related_brands_target_id'));
  $query->condition('entity_id', $training_id);

  return $query->execute()->fetchAllKeyed(0,0);
}

/**
 * Implements hook_views_pre_render().
 */
function crealead_trainings_views_pre_render(&$view) {
  if ($view->name == 'trainings' && $view->current_display == 'list_page') {
    drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_view_trainings.js');
    drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_training_list.js');
  }
  // If brand's training tab
  if ($view->name == 'trainings' && $view->current_display == 'entity_view_1') {
    // Link 'Ajouter une formation' must be added to block only for coes attached to the current brand.
    if (isset($view->current_entity)) {
      $current_brand = $view->current_entity;
    }
    else {
      $current_brand = node_load(arg(1));
    }
    $wrapper = entity_metadata_wrapper('node', $current_brand);
    $brand_coes = $wrapper->field_brand_coes->value();

    global $user;
    foreach ($brand_coes as $brand_coe) {
      if ($user->uid != $brand_coe->field_brand_coe['und'][0]['target_id']) {
        continue;
      }
      else {
        $view->header['area']->options['content'] = l(
          'Ajouter une formation',
          '/node/add/training/' . $current_brand->nid,
          array('query' => array('destination' => current_path() . '#bootstrap-fieldgroup-nav-item--solutions'))
        );
        break;
      }
    }
  }
  // Training session dates sorting (Sorting setting in Views produce wrong result).
  elseif ($view->name == 'trainings' && $view->current_display == 'training_sessions') {
    $sessions = array();
    foreach ($view->result as $session) {
      $sessions[$session->field_field_session_dates[0]['raw']['value']] = $session;
    };
    // We sort the $sessions array by keys which are strings representing dates in ISO format.
    ksort($sessions);
    $view->result = $sessions;
  }
  elseif ($view->name == 'trainings' && ($view->current_display == 'next_sessions' || $view->current_display == 'all_sessions')) {
    drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_trainings_sessions.js');

    /*
     * The 2 view displays 'next_sessions' and 'all_sessions' have been build
     * without date filter and without date sorting to prevent unpredictable results.
     * Both displays fetch all sessions belonging to a given training.
     * So, we have to filter and sort results here.
     *
     * RULE 1 - The 2 displays must must filter sessions having the last date greater than current date.
     * For instance:
     *
     * Current date:                          21/11/2017
     *
     * Session 1                                           25/11/2017  15/12/2017  -> visible
     * Session 2                  15/11/2017               25/11/2017              -> visible
     * Session 3     10/10/2017   15/11/2017   21/11/2017                          -> visible
     * Session 4     10/10/2017   15/11/2017                                       -> no longer visible
     *
     * RULE 2 - The 'next_sessions' display must keep the next 3 sessions only.
     *
     * RULE 3 - the session list must be sorted by first date ascending value.     *
     */
    $coming_sessions = array();
    foreach ($view->result as $key=>$item) {
      $first_session_date = date('Ymd', strtotime($item->field_field_session_dates[0]['raw']['value']));
      $last_session_date = date('Ymd', strtotime($item->field_field_session_dates_1[0]['raw']['value']));
      $current_date = date('Ymd');

      if ($last_session_date >= $current_date) { // Rule 1
        if (($view->current_display == 'next_sessions' && sizeof($coming_sessions) < 3) || $view->current_display == 'all_sessions') { // Rule 2
          $coming_sessions[$first_session_date] = $item;
        }
      }
    }
    ksort($coming_sessions); // Rule 3

    $view->result = $coming_sessions;
  }
  elseif ($view->name == 'brand_agenda' && $view->current_display == 'attachment_2') {
    foreach ($view->result as $key => $item) {
      $delta = $item->field_data_field_session_dates_delta;

//      $markup = $view->result[$key]->field_field_related_training[0]['rendered']['#markup'];
//      $ellipsis = ' ';
//      $nb_chars = 20;
//      if (strlen($markup) > $nb_chars) {
//        $ellipsis = '... ';
//      }
//      $view->result[$key]->field_field_related_training[0]['rendered']['#markup'] = substr($markup, 0, 20) . $ellipsis . '(jour ' . ($delta + 1) . ')';

      $view->result[$key]->field_field_related_training[0]['rendered']['#markup'] .= ' (jour ' . ($delta + 1) . ')';
    }
  }
  elseif ($view->name == 'trainings_calendar_prod') {
    foreach ($view->result as $key => $item) {
      if ($item->_field_data['nid']['entity']->type == 'training_session') {
        $delta = $item->field_data_field_session_dates_delta;
        $view->result[$key]->node_title = $item->field_field_related_training[0]['raw']['entity']->title . ' (J' . ($delta + 1) . ')';
      }
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function crealead_trainings_form_alter(&$form, &$form_state, $form_id) {
  if ($form['#id'] == 'views-exposed-form-trainings-list-page') {
    $form['title']['#field_suffix'] = 'Vous ne vous souvenez plus exactement du libellé ?<br /> Une lettre suffit pour lancer la recherche.';
  }
  elseif ($form_id == 'training_session_node_form') {
    drupal_add_js(drupal_get_path('module','crealead_trainings') . '/js/crealead_training_sessions_add.js');

    // Current user trainings
    global $user;
    if (!empty($current_user_trainings = crealead_trainings_get_user_trainings($user->uid))) {
      $params = array();
      foreach ($current_user_trainings as $training) {
        $params[$training->nid] = $training->extraFields->field_crealead_funded_;
      }
      drupal_add_js(array('creaeladTrainingsFunding' => $params), 'setting');
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function crealead_trainings_form_training_session_node_form_alter(&$form, &$form_state, $form_id) {
  $form['intro'] = array(
    '#type' => 'item',
    '#markup' => 'Vous n\'avez pas à saisir le titre de la session.<br/>' .
      'Celui-ci sera (re)créé automatiquement à partir ' .
      'du <b><i>titre</i></b> de la formation sélectionnée et de la <b><i>première date</i></b> de la session.',
    '#weight' => -1,

  );
  // If session is being created
  if (!isset($form['nid']['#value'])) {
    // We must provide a temporary title to pass validation successfully.
    // Then an eventual title is created in the custom submit function.
    // See function crealead_trainings_training_session_submit_handler() below.
    $form['title']['#default_value'] = 'temporary title';

    // If session is being created from a training page, we must catch the training nid from url
    // and select the corresponding training in field_related_training field.
    if (!isset($form['nid']['#value']) && NULL != arg(3)) {
      $form['field_related_training']['und']['#default_value'] = array(arg(3));
      $form['field_funded_session']['und']['#default_value'] = arg(4);
    }
  }

  // If session is being modified :
  // 1) if the current user is not the session author, we must display the select list of auhor's trainings.
  // 2) if session node was created before V3 sprint 3, the new compulsory field_funded_session is NULL.
  // So we must force its value to zero.
  elseif (isset($form['nid']['#value'])) {
    // 1) trainings list
    $session_author_trainings = views_get_view_result('trainings','user_trainings', $form['uid']['#value']);

    $options = array();
    if (!empty($session_author_trainings)) {
      foreach ($session_author_trainings as $training) {
          $options[$training->nid] = $training->node_title;
      }
    }

    $current_related_training = $form_state['node']->field_related_training['und'][0]['target_id'];
    $form['field_related_training']['und']['#options'] = $options;
    $form['field_related_training']['und']['#default_value'] = array($current_related_training);

    // 2) field_funded_session
    if (empty($form_state['node']->field_funded_session)) {
      $form['field_funded_session']['und']['#default_value'] = 0;
    }
  }

  $form['#submit'][] = 'crealead_trainings_training_session_submit_handler';
}

function crealead_trainings_training_session_submit_handler($form, &$form_state) {
  // Retrieve selected training
  $selected_training = $form_state['input']['field_related_training']['und'];
  $training_title = $form['field_related_training']['und']['#options'][$selected_training];

  // Retrieve first session date
  $first_date = format_date(strtotime($form_state['values']['field_session_dates']['und'][0]['value']), 'custom', 'd M Y');

  // Build session title based on selected training and first session date.
  $form_state['values']['title'] = $training_title . ' (session commençant le ' . $first_date . ')';
}

/**
 * Return a training's session list whose at least one session date is greater than current date.
 * [EDIT] NO LONGER USED
 *
 * @param $training The training node.
 * @return string A string containing the renderer html code.
 */
//function crealead_trainings_get_next_sessions($training) {
//  $query = new EntityFieldQueryExtraFields();
//  $query->entityCondition('entity_type', 'node')
//    ->entityCondition('bundle', 'training_session')
//    ->propertyCondition('status', NODE_PUBLISHED)
//    ->fieldCondition('field_related_training', 'target_id', $training->nid)
//    ->addExtraField('', 'title', 'title', 'node')
//    ->addExtraField('field_session_dates','value');
//
//  $result = $query->execute();
//
//  if (!empty($result)) {
//    $sessions = $result['node'];
//    $current_date = date('Y-m-d');
//    $sessions_list = '';
//    global $user;
//
//    foreach ($sessions as $key=>$session) {
//      $max_date = max($session->extraFields->field_session_dates_);
//      if ($current_date <= substr($max_date,0,10)) {
//        $sessions_list .=
//          '<div class="views-row">' .
//              '<a href="/node/' . $session->nid . '" class="colorbox-node" data-inner-width="600" data-inner-height="300">' .
//                format_date(strtotime($session->extraFields->field_session_dates_[0]),'custom','d F Y') .
//              '</a>';
//
//              // If current user is the training author, we display an edit link for the listed session.
//              if ($training->uid == $user->uid) {
//                $sessions_list .=
//                  '<span class="views-field views-field-edit-node">' .
//                    '<a href="/node/' . $session->nid .'/edit?destination=node/' . $training->nid . '">' .
//                      'modifier' .
//                    '</a>' .
//                  '</span>';
//              }
//          $sessions_list .= '</div>';
//      }
//    }
//
//    return $sessions_list;
//  }
//}

/**
 * Implements hook_node_postsave().
 */
function crealead_trainings_node_postsave($node, $op) {
  if ($node->type == 'training') {
    if (($op == 'delete') || ($op == 'update' && $node->status == 0)) {
      if (!empty($sessions = crealead_trainings_get_training_sessions($node->nid))) {
        $unpublished_sessions_nids = 0;
        foreach ($sessions as $session) {
          if ($session->status == 1) {
            $session->status = 0;
            node_save($session);
            $unpublished_sessions_nids++;
          }
        }
        if ($op == 'delete') {
          $msg = "Node {$node->nid} has been deleted. " . $unpublished_sessions_nids . " of its " . sizeof($sessions) . " sessions have been unpublished.";
        }
        else {
          $msg = "Updated node {$node->nid} and " . $unpublished_sessions_nids . " of " . sizeof($sessions) . " sessions have been unpublished.";
        }
        watchdog('crealead_trainings', $msg);
      }
    }
    elseif ($op == 'update' && $node->status == 1 && $node->field_previous_status['und'][0]['value'] == 0) {
      if (!empty($sessions = crealead_trainings_get_training_sessions($node->nid))) {
        $published_sessions_nids = 0;
        foreach ($sessions as $session) {
          if ($session->status == 0) {
            $session->status = 1;
            node_save($session);
            $published_sessions_nids++;
          }
        }
        watchdog('crealead_trainings', "{$op}d node {$node->nid} and " . $published_sessions_nids . " of " . sizeof($sessions) . " sessions have been published.");
      }
    }
  }
}

function crealead_trainings_get_training_sessions($training_nid) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'training_session')
    ->fieldCondition('field_related_training','target_id', $training_nid);

  $result = $query->execute();
  if (isset($result['node'])) {
    return entity_load('node', array_keys($result['node']));
  }

  return array();
}

function crealead_trainings_get_user_trainings($uid) {
  $query = new EntityFieldQueryExtraFields();
  $result = $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'training')
    ->propertyCondition('status', NODE_PUBLISHED)
    ->propertyCondition('uid', $uid)
    ->addExtraField('', 'title', 'title', 'node')
    ->addExtraField('field_crealead_funded','value')
    ->execute();

  $trainings = array();
  if (!empty($result)) {
    $trainings = $result['node'];
  }

  return $trainings;
}

/**
 * Implements hook_block_info().
 */
function crealead_trainings_block_info() {
  $blocks = array();
  $blocks['crealead_calendar_legend'] = array(
    'info' => t('Crealead : Légende calendrier formations'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function crealead_trainings_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'crealead_calendar_legend' :
      $block['content'] = '<span class="calendar-legend">Sessions en rouge = Prise en charge partielle du financement par Crealead pour les Crealeadiens</span>';
  }

  return $block;
}
