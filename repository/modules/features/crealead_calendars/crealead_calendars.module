<?php
/**
 * @file
 * Code for the Calendriers feature.
 */

include_once 'crealead_calendars.features.inc';

/**
 * Implements hook_feeds_after_save().
 */
function crealead_calendars_feeds_after_save(FeedsSource $source, $entity, $item, $entity_id) {
//  dpm($source);
//  dpm($entity);
//  dpm($item);
//  dpm($entity_id);
}

/**
 * Implements hook_feeds_presave().
 */
function crealead_calendars_feeds_presave(FeedsSource $source, $entity, $item, $entity_id) {
  if ($entity->type == 'room_event') {
//    dpm($item);
//    dpm($entity);

    $rooms_tids = crealead_calendars_get_rooms_tids();
    $room = $item['salle'];
    $entity->field_room = array('und' => array('0' => array('tid' => $rooms_tids[$room])));
  }
}

function crealead_calendars_get_rooms_tids() {
  $rooms_tids = &drupal_static(__FUNCTION__);
  if (!isset($my_data)) {
    $room_terms = taxonomy_get_tree(taxonomy_vocabulary_machine_name_load('crealead_rooms')->vid);
    $rooms_tids = array();
    foreach ($room_terms as $term) {
      $rooms_tids[$term->name] = $term->tid;
    }
  }

  return $rooms_tids;
}

/**
 * Implements hook_views_pre_render().
 */
function crealead_calendars_views_pre_render(&$view) {
  if ($view->name == 'structure_calendar') {
    if (user_access('create structure_event content')) {
      $add_link = '<a href="/node/add/structure-event">Ajouter un événement</a>';
//      $add_link = '<a href="/node/add/structure-event?destination=' . current_path() . '">Ajouter un événement</a>';
    }
    else {
      $add_link = '';
    }
    $view->header['area']->options['content'] = str_replace('LIEN_AJOUTER', $add_link, $view->header['area']->options['content']);
  }
  elseif ($view->name == 'rooms_calendar') {
    drupal_add_css(drupal_get_path('module', 'crealead_calendars') . '/css/crealead_calendars_rooms.css');
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function crealead_calendars_form_structure_event_node_form_alter(&$form, &$form_state, $form_id) {
  if (!isset($form['nid']['#value'])) {
    $form['actions']['submit']['#submit'][] = 'crealead_calendars_structure_event_redirect';
  }
}

function crealead_calendars_structure_event_redirect(&$form, &$form_state) {
  $event_start_date = $form_state['values']['field_gclal_date']['und'][0]['value'];
  $year_month = substr($event_start_date, 0, 7);
  $form_state['redirect'] = array(
    'espace-co-entrepreneur/informations',
    array(
      'query' => array(
        'mini' => $year_month,
      )
    )
  );
  drupal_set_message('L\événement structure a été ajouté.');
}
